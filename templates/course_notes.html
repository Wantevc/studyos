<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Notitieblok – {{ course.name }} | Study OS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-deep: #050509;
      --bg-deeper: #020307;
      --glass-soft: rgba(10, 12, 20, 0.34);
      --glass-border: rgba(255, 255, 255, 0.18);
      --text-main: #F8F7FD;
      --text-muted: #A7A6BC;
      --accent-gold: #F6DE9C;
      --accent-gold-strong: #F4CB63;
      --accent-blue: #60A5FA;
      --radius-lg: 18px;
      --radius-xl: 26px;
      --shadow-soft: 0 24px 60px rgba(0, 0, 0, 0.86);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
      background:
        radial-gradient(circle at 0% -20%, rgba(246,222,156,0.26), transparent 60%),
        radial-gradient(circle at 100% 120%, rgba(150,120,255,0.15), transparent 55%),
        linear-gradient(145deg, var(--bg-deep), var(--bg-deeper));
      display: flex;
      justify-content: center;
      padding: 18px 14px 28px;
    }

    .app-shell {
      width: 100%;
      max-width: 1180px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 18px;
      border-radius: 999px;
      background: linear-gradient(120deg, rgba(12, 13, 20, 0.95), rgba(12, 10, 6, 0.96));
      border: 1px solid rgba(255,255,255,0.16);
      box-shadow: 0 18px 40px rgba(0,0,0,0.85);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
    }
    .nav-left { display: flex; align-items: center; gap: 10px; }
    .nav-logo {
      width: 36px; height: 36px; border-radius: 999px;
      background: radial-gradient(circle at 30% 10%, #FFFFFF, #FFF8E1, #F6DE9C, #C29B3C);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.85), 0 10px 24px rgba(0,0,0,0.9);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #2B1B04; font-weight: 800;
    }
    .nav-title-main { font-size: 18px; font-weight: 600; letter-spacing: 0.14em; text-transform: uppercase; }
    .nav-title-sub { font-size: 11px; text-transform: uppercase; letter-spacing: 0.16em; color: var(--text-muted); }
    .nav-links a {
      font-size: 13px;
      color: var(--text-main);
      text-decoration: none;
      margin-left: 14px;
      opacity: 0.85;
    }
    .nav-links a:hover { opacity: 1; }

    .btn {
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      border: 1px solid transparent;
      cursor: pointer;
      background: none;
      color: inherit;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .btn-ghost {
      border-color: rgba(255,255,255,0.18);
      background: transparent;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.04); }
    .btn-primary {
      background: radial-gradient(circle at 25% 0%, #FFFDF3, #F6DE9C, #C69735);
      color: #2B1B04;
      font-weight: 500;
      box-shadow: 0 12px 26px rgba(0,0,0,0.9), 0 0 0 1px rgba(0,0,0,0.85);
    }
    .btn-primary:hover { transform: translateY(-1px); }

    .workspace {
      border-radius: var(--radius-xl);
      background: linear-gradient(145deg, rgba(8, 10, 18, 0.96), rgba(14, 10, 6, 0.96));
      border: 1px solid rgba(255,255,255,0.18);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 18px;
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 70vh;
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
      gap: 8px;
    }
    .page-title {
      font-size: 18px;
      font-weight: 600;
    }
    .page-sub {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 3px;
    }
    .badge {
      font-size: 11px;
      color: var(--text-muted);
    }

    .notes-layout {
      margin-top: 10px;
      display: grid;
      grid-template-columns: 260px minmax(0, 1fr);
      gap: 12px;
      min-height: 360px;
    }
    @media (max-width: 820px) {
      .notes-layout {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      border-radius: var(--radius-lg);
      background: var(--glass-soft);
      border: 1px solid var(--glass-border);
      box-shadow: 0 16px 40px rgba(0,0,0,0.9);
      padding: 12px 12px 10px;
      font-size: 13px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
    }
    .panel-sub {
      font-size: 12px;
      color: var(--text-muted);
    }

    .folder-list {
      margin-top: 4px;
      list-style: none;
      padding-left: 0;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 160px;
      overflow-y: auto;
    }
    .folder-item {
      border-radius: 10px;
      padding: 5px 7px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .folder-item.active {
      background: rgba(0,0,0,0.4);
      border-color: rgba(246,222,156,0.6);
    }
    .folder-name {
      flex: 1;
    }
    .folder-count {
      font-size: 10px;
      color: var(--text-muted);
      white-space: nowrap;
    }
    .folder-delete-btn {
      border: none;
      background: transparent;
      color: #fca5a5;
      font-size: 10px;
      cursor: pointer;
    }

    .notes-list {
      margin-top: 6px;
      list-style: none;
      padding-left: 0;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 180px;
      overflow-y: auto;
    }
    .note-item {
      border-radius: 10px;
      padding: 5px 7px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      border: 1px solid transparent;
    }
    .note-item.active {
      background: rgba(0,0,0,0.4);
      border-color: rgba(96,165,250,0.6);
    }
    .note-title {
      flex: 1;
    }
    .note-delete-btn {
      border: none;
      background: transparent;
      color: #fca5a5;
      font-size: 10px;
      cursor: pointer;
    }

    .small-form input[type="text"] {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 8px;
      background: rgba(0,0,0,0.4);
      color: var(--text-main);
      font-size: 12px;
    }
    .small-form input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-gold-strong);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.9), 0 0 0 4px rgba(246,222,156,0.25);
    }

    .editor-title {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 10px;
      background: rgba(0,0,0,0.35);
      color: var(--text-main);
      font-size: 13px;
      margin-bottom: 6px;
    }
    .editor-title:focus {
      outline: none;
      border-color: var(--accent-gold-strong);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.9), 0 0 0 4px rgba(246,222,156,0.25);
    }

    .editor-textarea {
      width: 100%;
      min-height: 260px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 8px 10px;
      background: rgba(0,0,0,0.4);
      color: var(--text-main);
      font-size: 13px;
      resize: vertical;
      white-space: pre-wrap;
    }
    .editor-textarea:focus {
      outline: none;
      border-color: var(--accent-gold-strong);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.9), 0 0 0 4px rgba(246,222,156,0.25);
    }

    .editor-bottom {
      margin-top: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-muted);
    }

/* AI Assistant panel */
    .ai-toggle-btn {
      margin-left: 8px;
    }

    .ai-panel {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 320px;
      max-width: 90vw;
      max-height: 70vh;
      border-radius: 18px;
      background: radial-gradient(circle at 0 0, rgba(96,165,250,0.18), transparent 65%),
                  rgba(10,12,20,0.96);
      border: 1px solid rgba(148,163,184,0.9);
      box-shadow: 0 22px 60px rgba(0,0,0,0.9);
      display: none;
      flex-direction: column;
      overflow: hidden;
      z-index: 40;
    }

    .ai-panel.open {
      display: flex;
    }

    .ai-panel-header {
      padding: 8px 10px;
      border-bottom: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    .ai-panel-title {
      font-weight: 600;
      font-size: 12px;
    }
    .ai-panel-sub {
      font-size: 11px;
      color: var(--text-muted);
    }
    .ai-close-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
    }

    .ai-messages {
      padding: 8px 10px;
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .ai-bubble {
      max-width: 90%;
      border-radius: 14px;
      padding: 6px 8px;
      line-height: 1.4;
    }
    .ai-bubble-user {
      align-self: flex-end;
      background: rgba(248,250,252,0.12);
      border-top-right-radius: 2px;
    }
    .ai-bubble-assistant {
      align-self: flex-start;
      background: rgba(15,23,42,0.95);
      border-top-left-radius: 2px;
      border: 1px solid rgba(148,163,184,0.6);
    }

    .ai-typing {
      font-size: 12px;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    .ai-typing-dot {
      width: 4px;
      height: 4px;
      border-radius: 999px;
      background: var(--accent-gold);
      animation: aiDot 1s infinite ease-in-out;
    }
    .ai-typing-dot:nth-child(2) { animation-delay: 0.15s; }
    .ai-typing-dot:nth-child(3) { animation-delay: 0.3s; }

    @keyframes aiDot {
      0% { transform: translateY(0); opacity: 0.4; }
      50% { transform: translateY(-3px); opacity: 1; }
      100% { transform: translateY(0); opacity: 0.4; }
    }

    .ai-input-bar {
      padding: 6px 8px 8px;
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .ai-input-row {
      display: flex;
      gap: 6px;
    }
    .ai-input-row input[type="text"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 6px 9px;
      background: rgba(0,0,0,0.6);
      color: var(--text-main);
      font-size: 12px;
    }
    .ai-input-row input[type="text"]:focus {
      outline: none;
      border-color: var(--accent-gold-strong);
      box-shadow: 0 0 0 1px rgba(0,0,0,0.9), 0 0 0 4px rgba(246,222,156,0.25);
    }
    .ai-input-row button {
      border-radius: 999px;
      border: 1px solid rgba(248,250,252,0.4);
      background: rgba(248,250,252,0.1);
      color: #f9fafb;
      font-size: 12px;
      padding: 6px 10px;
      cursor: pointer;
    }
    .ai-input-row button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .ai-footnote {
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }
    .ai-footnote button {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 0;
      cursor: pointer;
      text-decoration: underline;
    }
  </style>
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='scroll.css') }}">
</head>
<body>
  <div class="app-shell">
    <header class="nav">
      <div class="nav-left">
        <div class="nav-logo">S</div>
        <div>
          <div class="nav-title-main">STUDY OS</div>
          <div class="nav-title-sub">AI STUDY SYSTEM · NOTITIEBLOK</div>
        </div>
      </div>
      <div class="nav-links">
        <a href="{{ url_for('home') }}">Dashboard</a>
        <a href="{{ url_for('courses') }}">Vakken</a>
        <a href="{{ url_for('course_detail', course_id=course_id) }}">Terug naar vak</a>
      </div>
    </header>

    <main class="workspace">
      <div class="page-header">
        <div>
          <div class="page-title">Notitieblok – {{ course.name }}</div>
          <div class="page-sub">
            Maak mappen en notities als een mini-verkenner voor dit vak.
          </div>
        </div>
        <div style="text-align:right;">
          <div class="badge">
            {% if folders %}
              {{ folders|length }} map(pen)
            {% else %}
              Nog geen mappen
            {% endif %}
          </div>
          <button type="button" class="btn btn-primary ai-toggle-btn" onclick="toggleAiPanel()">
            AI Help
          </button>
        </div>
      </div>

      <section class="notes-layout">
        <!-- Links: mappen + notities -->
        <article class="panel">
          <div class="panel-title">Mappen & notities</div>
          <div class="panel-sub">
            Maak bijvoorbeeld een map per hoofdstuk, en daarbinnen notities voor samenvattingen.
          </div>

          <!-- Mappen -->
          <ul class="folder-list">
            {% for f in folders %}
            <li class="folder-item {% if loop.index0 == folder_index %}active{% endif %}">
              <a class="folder-name"
                 href="{{ url_for('course_notes', course_id=course_id, folder=loop.index0) }}"
                 style="text-decoration:none; color:inherit;">
                {{ f.name }}
              </a>
              <span class="folder-count">
                {{ (f.notes or [])|length }} docs
              </span>
              <form method="post"
                    action="{{ url_for('delete_notes_folder', course_id=course_id, folder_index=loop.index0) }}"
                    style="margin:0;"
                    onsubmit="return confirm('Hele map + notities verwijderen?');">
                <button type="submit" class="folder-delete-btn">×</button>
              </form>
            </li>
            {% endfor %}
          </ul>

          <form class="small-form" method="post" action="{{ url_for('add_notes_folder', course_id=course_id) }}" style="margin-top:6px;">
            <input type="text" name="folder_name" placeholder="Nieuwe map (bijv. Hoofdstuk 1)" required>
            <button type="submit" class="btn btn-primary" style="margin-top:4px; width:100%; justify-content:center;">
              + Map toevoegen
            </button>
          </form>

          {% if active_folder %}
          <div class="panel-sub" style="margin-top:10px;">
            Notities in: <strong>{{ active_folder.name }}</strong>
          </div>
          <ul class="notes-list">
            {% for n in active_folder.notes %}
            <li class="note-item {% if loop.index0 == note_index %}active{% endif %}">
              <a class="note-title"
                 href="{{ url_for('course_notes', course_id=course_id, folder=folder_index, note=loop.index0) }}"
                 style="text-decoration:none; color:inherit;">
                {{ n.title }}
              </a>
              <form method="post"
                    action="{{ url_for('delete_note', course_id=course_id, folder_index=folder_index, note_index=loop.index0) }}"
                    style="margin:0;"
                    onsubmit="return confirm('Deze notitie verwijderen?');">
                <button type="submit" class="note-delete-btn">×</button>
              </form>
            </li>
            {% endfor %}
          </ul>

          <form class="small-form" method="post"
                action="{{ url_for('add_note', course_id=course_id, folder_index=folder_index) }}"
                style="margin-top:6px;">
            <input type="text" name="note_title" placeholder="Nieuwe notitie (bijv. Samenvatting synapsen)" required>
            <button type="submit" class="btn btn-ghost" style="margin-top:4px; width:100%; justify-content:center;">
              + Notitie toevoegen
            </button>
          </form>
          {% else %}
          <div class="panel-sub" style="margin-top:8px;">
            Maak eerst een map aan om notities in te bewaren.
          </div>
          {% endif %}
        </article>

        <!-- Rechts: editor -->
        <article class="panel">
          <div class="panel-title">Editor</div>
          <div class="panel-sub">
            Schrijf hier je samenvattingen, formules, ezelsbruggen, enz.
          </div>

          {% if active_folder and active_note %}
          <form method="post"
                action="{{ url_for('save_note', course_id=course_id, folder_index=folder_index, note_index=note_index) }}"
                style="display:flex; flex-direction:column; gap:6px; flex:1;">
            <input type="text"
                   class="editor-title"
                   name="note_title"
                   value="{{ active_note.title }}"
                   placeholder="Titel van de notitie">

            <textarea class="editor-textarea"
                      name="note_content"
                      placeholder="Begin met typen...">{{ active_note.content }}</textarea>

            <div class="editor-bottom">
              <span>
                Map: {{ active_folder.name }} · Document {{ note_index + 1 }} van {{ active_folder.notes|length }}
              </span>
              <button type="submit" class="btn btn-primary">
                Opslaan
              </button>
            </div>
          </form>
          {% elif active_folder and not active_note %}
          <div class="panel-sub" style="margin-top:6px;">
            Nog geen notities in deze map. Voeg eerst een notitie toe links.
          </div>
          {% else %}
          <div class="panel-sub" style="margin-top:6px;">
            Maak eerst een map aan met notities aan de linkerkant.
          </div>
          {% endif %}
        </article>
      </section>
<!-- AI Assistant panel -->
      <div id="ai-panel" class="ai-panel">
        <div class="ai-panel-header">
          <div>
            <div class="ai-panel-title">{{ assistant_name }}</div>
            <div class="ai-panel-sub">Stel vragen over dit vak, je notities en examen.</div>
          </div>
          <button class="ai-close-btn" type="button" onclick="toggleAiPanel(false)">×</button>
        </div>
        <div id="ai-messages" class="ai-messages">
          {% if ai_history %}
            {% for msg in ai_history %}
              <div class="ai-bubble {% if msg.role == 'user' %}ai-bubble-user{% else %}ai-bubble-assistant{% endif %}">
                {{ msg.content }}
              </div>
            {% endfor %}
          {% else %}
            <div class="ai-bubble ai-bubble-assistant">
              Hey, ik ben je {{ assistant_name }}.  
              Ik ken de topics, vragen, planning en notities van dit vak.
              Vraag me gerust om uitleg, samenvattingen of examengerichte tips.
            </div>
          {% endif %}
        </div>
        <div class="ai-input-bar">
          <div class="ai-input-row">
            <input type="text" id="ai-input" placeholder="Stel een vraag aan je vak-coach..." />
            <button id="ai-send-btn" type="button" onclick="sendAiMessage()">Stuur</button>
          </div>
          <div class="ai-footnote">
            <span id="ai-status-text"></span>
            <button type="button" onclick="clearAiConversation()">Wis gesprek (bespaart geheugen)</button>
          </div>
        </div>
      </div>
    </main>
  </div>
<script>
  let aiOpen = false;
  let aiLoading = false;

  function toggleAiPanel(force) {
    const panel = document.getElementById('ai-panel');
    aiOpen = (typeof force === 'boolean') ? force : !aiOpen;
    if (aiOpen) {
      panel.classList.add('open');
      // Focus input
      setTimeout(() => {
        const input = document.getElementById('ai-input');
        if (input) { input.focus(); }
      }, 50);
    } else {
      panel.classList.remove('open');
    }
  }

  function appendMessage(role, text) {
    const container = document.getElementById('ai-messages');
    const div = document.createElement('div');
    div.className = 'ai-bubble ' + (role === 'user' ? 'ai-bubble-user' : 'ai-bubble-assistant');
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }

  let typingNode = null;

  function showTyping() {
    const container = document.getElementById('ai-messages');
    const wrapper = document.createElement('div');
    wrapper.className = 'ai-bubble ai-bubble-assistant';
    const span = document.createElement('span');
    span.className = 'ai-typing';
    span.innerHTML = '<span class="ai-typing-dot"></span><span class="ai-typing-dot"></span><span class="ai-typing-dot"></span>';
    wrapper.appendChild(span);
    container.appendChild(wrapper);
    container.scrollTop = container.scrollHeight;
    typingNode = wrapper;
  }

  function hideTyping() {
    if (typingNode && typingNode.parentNode) {
      typingNode.parentNode.removeChild(typingNode);
    }
    typingNode = null;
  }

  async function sendAiMessage() {
    if (aiLoading) return;
    const input = document.getElementById('ai-input');
    const btn = document.getElementById('ai-send-btn');
    const status = document.getElementById('ai-status-text');

    const text = (input.value || '').trim();
    if (!text) return;

    aiLoading = true;
    input.disabled = true;
    btn.disabled = true;
    status.textContent = "AI is je vak aan het doorzoeken...";

    appendMessage('user', text);
    input.value = '';

    showTyping();

    try {
      const resp = await fetch("{{ url_for('course_notes_ai_chat', course_id=course_id) }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text }),
      });
      const data = await resp.json();
      hideTyping();

      if (data.reply) {
        appendMessage('assistant', data.reply);
        status.textContent = "";
      } else {
        appendMessage('assistant', "Er ging iets mis bij het ophalen van een antwoord.");
        status.textContent = data.error || "AI fout.";
      }
    } catch (e) {
      hideTyping();
      appendMessage('assistant', "Netwerk- of serverfout bij AI.");
      status.textContent = "Kon AI niet bereiken.";
    } finally {
      aiLoading = false;
      input.disabled = false;
      btn.disabled = false;
      input.focus();
    }
  }

  async function clearAiConversation() {
    if (!confirm("Gesprek wissen? Dit bespaart geheugen.")) return;
    const status = document.getElementById('ai-status-text');
    status.textContent = "Gesprek wordt gewist...";

    try {
      await fetch("{{ url_for('course_notes_ai_clear', course_id=course_id) }}", {
        method: "POST"
      });
      const container = document.getElementById('ai-messages');
      container.innerHTML = "";
      appendMessage('assistant', "Gesprek gewist. Ik ben klaar voor een nieuwe start met dit vak!");
      status.textContent = "Gesprek gewist (geheugen vrijgemaakt).";
    } catch (e) {
      status.textContent = "Kon gesprek niet wissen.";
    }
  }

  // Enter om te sturen
  document.addEventListener('DOMContentLoaded', () => {
    const input = document.getElementById('ai-input');
    if (input) {
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendAiMessage();
        }
      });
    }
  });
</script>
</body>
</html>